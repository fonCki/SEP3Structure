@inject NavigationManager navigationManager
@using Microsoft.AspNetCore.SignalR.Client;
@using Entities
@page "/Chat"
<h3>Chat</h3>

@if (!online) {
    //Insert Login Component
    <input type="text" @bind="@nickName" />
    <button type="button" onclick="@LaunchChat">Start</button>
    
    @if (information != null) {
        <p>@information</p>
    }
}
else {
    //Insert Header with user information
    <h1>@nickName</h1>
    <div class="alert alert-danger">
        @foreach (var message in messages) {
            <div>
                <h6>@message.NickName</h6>
                <p>@message.Body</p>
            </div>
        }
    </div>
    <textarea placeholder="write your message" @bind="newMessage" @bind:event="oninput"></textarea>
    <button @onclick="@(() => SendMessage(newMessage))">Send</button>
}

@code {

    private bool online = false;
    
    private string nickName;
    
    private string information; // information to be shown on screen 

    private string newMessage;
    
    List<Message> messages = new List<Message>();

    private HubConnection? hubConnection;

    private Timer timer;

    private void Timer(object? o) {
        InvokeAsync(StateHasChanged);
    }
    
    public async Task LaunchChat() {
        
        try {
            timer = new Timer(Timer, null, 0, 1);

            online = true;
            await Task.Delay(1);
            
            //Remove old Messages
            messages.Clear();
            
            
            //Start the connection

            hubConnection = new HubConnectionBuilder().WithUrl("https://localhost:7198/chat").Build();
            hubConnection.On<string, string>("Broadcast", ReceiveMessage);

            await hubConnection.StartAsync();

            await SendMessage("I just join the chat");
        }
        catch (Exception e) {
            information = e.Message;
            online = false;
        }
    }

    private void ReceiveMessage(string nickName, string message) {
        messages.Add(new Message(nickName, message));
        StateHasChanged();
    }

    private async Task SendMessage(string message) {
        if (online) {
            await hubConnection.SendAsync("Broadcast", nickName, message);
            newMessage = "";
        }
    }


}
